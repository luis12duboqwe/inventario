# Verificación integral de capacidades — Softmobile 2025 v2.2.0

Este informe cruza lo descrito en `README.md` y `AGENTS.md` con la implementación actual. Cada requisito indica su estado y pasos explícitos en caso de detectar brechas, manteniendo la versión 2.2.0 intacta.

## Metodología

1. Revisión de los requisitos listados en "Capacidades implementadas" y "Dashboard modularizado" del README.【F:README.md†L16-L66】
2. Inspección de routers, servicios y componentes React asociados a cada capacidad, verificando flags y dependencias obligatorias.【F:backend/app/main.py†L15-L191】【F:frontend/src/modules/operations/pages/OperationsPage.tsx†L1-L162】
3. Ejecución de la suite `pytest` para corroborar el estado real de las pruebas automatizadas y detectar regresiones en auditoría/ métricas.【e79d2d†L1-L88】

## Backend

| Requisito (README/AGENTS) | Implementación inspeccionada | Estado | Acciones / pasos siguientes |
| --- | --- | --- | --- |
| API FastAPI con routers para inventario, POS, compras, transferencias, reportes y sincronización.【F:README.md†L16-L41】 | `create_app()` registra todos los routers corporativos y aplica los middlewares de motivo y permisos.【F:backend/app/main.py†L83-L191】 | ✅ Cumplido | Mantener los prefijos existentes cuando se agreguen nuevos endpoints. |
| Seguridad por roles, JWT y sesiones activas auditables.【F:README.md†L17-L18】【F:AGENTS.md†L8-L18】 | `security.py` gestiona tokens, dependencias de roles y 2FA opcional; el middleware revisa `X-Reason` y sesiones activas.【F:backend/app/security.py†L1-L96】【F:backend/app/main.py†L94-L170】 | ⚠️ Parcial | Completar endpoints de auditoría (ver fila dedicada) y documentar la política de `X-Reason` tras decidir si la exportación CSV debe exigirla. Sigue `docs/guia_revision_total_v2.2.0.md` para la lista de pasos detallados. |
| Gestión de inventario ampliada y búsqueda avanzada (Catálogo Pro).【F:README.md†L18-L19】 | El router `inventory.py` permite movimientos, actualización de dispositivos y búsquedas con filtros IMEI/serial condicionadas por el flag Pro.【F:backend/app/routers/inventory.py†L18-L96】 | ✅ Cumplido | Añadir pruebas adicionales si se incorporan nuevos filtros. |
| Transferencias SOLICITADA→EN_TRANSITO→RECIBIDA/CANCELADA con permisos por sucursal.【F:README.md†L26-L27】 | `transfers.py` valida el feature flag, controla transiciones y motivos en cada cambio de estado.【F:backend/app/routers/transfers.py†L13-L134】 | ✅ Cumplido | Sin acciones inmediatas. |
| Compras, ventas, devoluciones, importación CSV y plantillas recurrentes.【F:README.md†L27-L29】 | `purchases.py`, `sales.py`, `pos.py` y `operations.py` cubren los flujos descritos, incluyendo CSV y ordenes recurrentes con `require_reason`.【F:backend/app/routers/purchases.py†L14-L199】【F:backend/app/routers/sales.py†L14-L105】【F:backend/app/routers/pos.py†L19-L185】【F:backend/app/routers/operations.py†L15-L134】 | ✅ Cumplido | Mantener sincronizada la lógica de costos promedio con inventario al agregar nuevas mutaciones. |
| Reportes analíticos avanzados (rotación, aging, forecast, comparativos, margen, proyección, alertas, tiempo real).【F:README.md†L36-L39】 | `reports.py` expone las rutas `/reports/analytics/*` y normaliza filtros por sucursal/fechas antes de delegar a `crud`.【F:backend/app/routers/reports.py†L23-L120】 | ✅ Cumplido | Evaluar caches ligeros cuando se conecten dashboards externos. |
| Métricas globales con alertas críticas/pendientes reflejadas en `/reports/metrics`.【F:README.md†L19-L33】 | `crud.compute_inventory_metrics` agrega ventas, reparaciones y alertas para el tablero global, pero lanza `KeyError` al no incluir `entity_id` en `highlight`.【F:backend/app/crud.py†L1723-L1935】 | ❌ Faltante | Extender `audit_utils.HighlightEntry` para incluir `entity_id`, ajustar la agregación y actualizar pruebas (`test_stores.py`) antes de reejecutar `pytest`. Los pasos técnicos se detallan en `docs/guia_revision_total_v2.2.0.md`. |
| Auditoría con exportación CSV/PDF, recordatorios automáticos y acuses manuales.【F:README.md†L31-L33】 | El router `audit.py` sólo ofrece `/audit/logs` y `/audit/logs/export.csv` y el CSV falla sin `X-Reason`; no existen `/audit/reminders`, `/audit/acknowledgements` ni `/reports/audit/pdf` y el test oficial devuelve 400.【F:backend/app/routers/audit.py†L16-L68】【e79d2d†L1-L52】 | ❌ Faltante | Implementar los endpoints faltantes, decidir si la exportación exige motivo (y alinear pruebas/fixtures), conectar `services.audit.render_audit_pdf` y reejecutar `pytest`. Referencia rápida en `docs/guia_revision_total_v2.2.0.md`. |
| Sincronización híbrida con `sync_outbox` y reintentos automáticos.【F:README.md†L38-L41】【F:AGENTS.md†L60-L88】 | `sync.py` expone historial, estadísticas y reintentos; `services/sync.py` reprograma eventos fallidos respetando `sync_max_attempts`.【F:backend/app/routers/sync.py†L14-L124】【F:backend/app/services/sync.py†L1-L100】 | ✅ Cumplido | Añadir monitoreo multi-entidad cuando se incorporen nuevas tablas. |
| Respaldos empresariales automáticos/manuales.【F:README.md†L21-L22】 | `backups.py` dispara respaldos PDF/JSON vía `services.backups` y lista historial para roles autorizados.【F:backend/app/routers/backups.py†L17-L39】 | ✅ Cumplido | Documentar en README cualquier cambio de directorio de destino. |
| Módulo de actualizaciones ligado a `docs/releases.json`.【F:README.md†L22-L23】 | `updates.py` provee `/updates/status` y `/updates/history` consultando el feed local indicado en la configuración.【F:backend/app/routers/updates.py†L11-L28】【F:backend/app/config.py†L80-L83】 | ✅ Cumplido | Actualizar `docs/releases.json` sólo cuando existan nuevos lanzamientos oficiales. |
| Feature flags operativos (`SOFTMOBILE_ENABLE_*`).【F:AGENTS.md†L40-L68】 | `Settings` define todos los flags y los routers validan disponibilidad antes de atender solicitudes sensibles.【F:backend/app/config.py†L51-L74】【F:backend/app/routers/purchases.py†L17-L23】 | ✅ Cumplido | Mantener la coherencia al introducir nuevos flags (nombrado y default). |

## Frontend

| Requisito (README/AGENTS) | Implementación inspeccionada | Estado | Acciones / pasos siguientes |
| --- | --- | --- | --- |
| Dashboard modularizado: Inventario con Tabs, Operaciones con Accordion, Analítica en grilla 3x2, secciones con `.section-scroll`.【F:README.md†L60-L66】【F:AGENTS.md†L14-L18】 | `InventoryPage.tsx` orquesta tabs y estadísticas; `OperationsPage.tsx` agrupa POS/compras/transferencias en acordeones; `AnalyticsBoard.tsx` usa `AnalyticsGrid` para paneles 3x2.【F:frontend/src/modules/inventory/pages/InventoryPage.tsx†L1-L123】【F:frontend/src/modules/operations/pages/OperationsPage.tsx†L25-L160】【F:frontend/src/modules/analytics/components/AnalyticsBoard.tsx†L1-L143】 | ✅ Cumplido | Evitar romper la jerarquía de Tabs/Accordion/AnalyticsGrid al extender módulos. |
| Inventario con etiquetas QR y resaltado de low stock.【F:README.md†L18-L19】 | `InventoryTable.tsx` genera etiquetas mediante `qrcode` y resalta dispositivos con bajo inventario.【F:frontend/src/modules/inventory/components/InventoryTable.tsx†L1-L167】 | ✅ Cumplido | Añadir mensajes accesibles si se modifican los estilos de impresión. |
| POS directo con recibos PDF y motivos obligatorios.【F:README.md†L29-L35】 | `api.ts` firma ventas, configuraciones y recibos respetando `X-Reason`; el router POS genera PDFs con ReportLab.【F:frontend/src/api.ts†L1791-L1805】【F:backend/app/routers/pos.py†L30-L185】 | ✅ Cumplido | Mantener sincronizada la estructura del PDF si se ajustan campos fiscales. |
| Tablero global con métricas y alertas destacadas.【F:README.md†L39-L40】 | `GlobalMetrics.tsx` muestra tarjetas, gráficos y resúmenes de alertas críticas/preventivas.【F:frontend/src/modules/dashboard/components/GlobalMetrics.tsx†L1-L120】 | ⚠️ Parcial | Una vez que el backend devuelva el estado de acuse, incorporar indicadores de pendientes vs. atendidas (ver acciones backend). |
| Bitácora de auditoría con recordatorios, snooze y descargas CSV/PDF.【F:README.md†L31-L33】 | El componente actual no importa `useRef`, duplica `buildCurrentFilters` y llama a funciones inexistentes (`loadReminders`, `snoozedUntil`).【F:frontend/src/modules/security/components/AuditLog.tsx†L1-L198】 | ❌ Faltante | 1) Importar `useRef` y consolidar `buildCurrentFilters`. 2) Implementar estados/efectos para recordatorios y snooze conectados a los nuevos endpoints. 3) Manejar acuses desde la UI y actualizar toasts/tablas. |
| API cliente para auditoría (CSV/PDF).【F:README.md†L31-L33】 | `downloadAuditPdf` apunta a `/reports/audit/pdf`, recurso inexistente actualmente.【F:frontend/src/api.ts†L1773-L1788】 | ❌ Faltante | Crear el endpoint backend y manejar errores temporalmente en el frontend hasta que esté disponible. |
| Tema oscuro y componentes reutilizables (`ModuleHeader`, `LoadingOverlay`, `AnalyticsGrid`, `Accordion`, `Tabs`).【F:README.md†L45-L66】 | Los componentes existen en `frontend/src/components` y se reutilizan en las vistas auditadas.【F:frontend/src/components/ModuleHeader.tsx†L1-L120】【F:frontend/src/components/ui/AnalyticsGrid/AnalyticsGrid.tsx†L1-L27】【F:frontend/src/components/ui/Tabs/Tabs.tsx†L1-L44】 | ✅ Cumplido | Mantener la documentación actualizada si cambia la API pública de estos componentes. |

## Documentación y calidad

| Requisito | Implementación | Estado | Acciones |
| --- | --- | --- | --- |
| Evaluación de requerimientos alineada con el estado real.【F:AGENTS.md†L96-L106】 | `docs/evaluacion_requerimientos.md` marca Seguridad/Auditoría como parcial y enlaza al plan de cobertura actualizado.【F:docs/evaluacion_requerimientos.md†L5-L26】 | ✅ Vigente | Actualizar el estado una vez que se publiquen recordatorios/acuse y las pruebas pasen en verde. |
| Plan de cobertura operativo para cerrar brechas de auditoría/métricas.【F:AGENTS.md†L9-L18】 | `docs/plan_cobertura_v2.2.0.md` lista acciones específicas de backend, frontend y pruebas para completar auditoría y métricas.【F:docs/plan_cobertura_v2.2.0.md†L6-L213】 | ✅ Vigente | Añadir fechas de seguimiento cuando se implementen los endpoints. |
| Prompts de soporte y checklists actualizados según mandato.【F:AGENTS.md†L39-L59】 | Se añadió `docs/prompts_operativos_v2.2.0.md` con prompts por lote, seguridad, pruebas y checklist operativo reutilizable.【F:docs/prompts_operativos_v2.2.0.md†L1-L72】 | ✅ Vigente | Enlazar el documento desde README y actualizarlo cuando cambie el plan de cobertura. |
| Suite de pruebas `pytest` en verde.【F:AGENTS.md†L4-L11】 | La ejecución actual falla en `test_audit_filters_and_csv_export` y `test_inventory_flow` por las brechas descritas (400 al exportar CSV y `KeyError` en métricas).【e79d2d†L1-L88】 | ❌ Faltante | Ajustar política de `X-Reason`, reparar métricas/acuse y repetir `pytest` hasta obtener éxito. Registrar cada corrida en la bitácora interna. |

## Próximos pasos prioritarios

1. Implementar endpoints de recordatorios, acuses y PDF de auditoría, alineando `require_reason` con la política definitiva y actualizando `frontend/src/api.ts` y `AuditLog.tsx` en consecuencia.
2. Extender `audit_utils.HighlightEntry` y consumidores (`crud.compute_inventory_metrics`) para incluir `entity_id`, recalcular métricas ejecutivas y eliminar el `KeyError` que afecta al tablero global.
3. Reejecutar `pytest` y documentar el resultado en la bitácora interna junto con la fecha de corrección, cerrando las brechas identificadas en este informe.
